name: CI
on:
  push:
    tags: [ "*" ]
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: version
        id: version
        run: |
          echo "::set-output name=VERSION::${GITHUB_REF#refs/tags/}"

      - name: install
        run: |
          sudo apt update
          sudo apt -y install clang-9 libclang-9-dev cmake libgc-dev libgmp-dev binutils-dev zlib1g-dev libncurses-dev libboost-filesystem-dev libboost-regex-dev libboost-date-time-dev libboost-program-options-dev libboost-system-dev libboost-iostreams-dev libunwind-dev liblzma-dev libelf1 libelf-dev libbsd-dev sbcl

      - name: checkout
        uses: actions/checkout@v2

      - name: build
        run: |
          echo "::set-output neme=DIR::clasp-${{ steps.version.outputs.VERSION }}-x86-64-linux"
          git clone https://github.com/clasp-developers/clasp ${{ steps.build.outputs.DIR }}
          cd ${{ steps.build.outputs.DIR }}
          git checkout `cat ../hash`
          echo "USE_PARALLEL_BUILD  = True" > wscript.config
          echo "LINK_STATIC = True" >> wscript.config
          ./waf configure build_dboehm
          make

      - name: test
        run: |
          ${{ steps.build.outputs.DIR }}/build/boehm/iclasp-boehm -e '(core:quit)'

      - name: archive
        run: |
          echo "::set-output neme=FILE::clasp-${{ steps.version.outputs.VERSION }}-x86-64-linux-binary.tar.gz"
          rm ${{ steps.build.outputs.DIR }}/build/clasp
          rm ${{ steps.build.outputs.DIR }}/clasp/build/boehm/cclasp-boehm
          tar czf ${{ steps.version.archive.FILE }} ${{ steps.build.outputs.DIR }}/build

      - name: release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ${{ github.ref }}
          draft: false
          prerelease: false

      - name: upload
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_name: ${{ steps.version.archive.FILE }}
          asset_path: ./${{ steps.version.archive.FILE }}
          asset_content_type: application/gzip
